# üìä R√®gles d'Alerte Prometheus ‚Äî Dorevia Vault
# Sprint 4 Phase 4.3 ‚Äî Alerting & Supervision

groups:
  - name: dorevia_vault_business
    interval: 30s
    rules:
      # Alerte 1 : Taux d'erreur documents √©lev√©
      - alert: HighDocumentErrorRate
        expr: |
          (
            rate(documents_vaulted_total{status="error"}[5m]) /
            rate(documents_vaulted_total[5m])
          ) > 0.1
        for: 5m
        labels:
          severity: warning
          component: vault
          service: dorevia-vault
        annotations:
          summary: "Taux d'erreur √©lev√© lors du stockage de documents"
          description: |
            {{ $value | humanizePercentage }} des documents √©chouent sur les 5 derni√®res minutes.
            V√©rifier les logs et la sant√© du syst√®me.

      # Alerte 2 : Ledger append lent
      - alert: SlowLedgerAppend
        expr: |
          histogram_quantile(0.95, rate(ledger_append_duration_seconds_bucket[5m])) > 2
        for: 10m
        labels:
          severity: warning
          component: ledger
          service: dorevia-vault
        annotations:
          summary: "Ledger append lent (P95 > 2s)"
          description: |
            Le P95 du temps d'ajout au ledger est de {{ $value }}s.
            V√©rifier la charge de la base de donn√©es et les performances.

      # Alerte 3 : Erreurs ledger fr√©quentes
      - alert: FrequentLedgerErrors
        expr: |
          rate(ledger_append_errors_total[5m]) > 0.05
        for: 5m
        labels:
          severity: warning
          component: ledger
          service: dorevia-vault
        annotations:
          summary: "Erreurs ledger fr√©quentes"
          description: |
            {{ $value }} erreurs/seconde lors de l'ajout au ledger.
            V√©rifier l'int√©grit√© de la base de donn√©es et les contraintes.

      # Alerte 4 : Stockage presque plein
      - alert: StorageNearlyFull
        expr: |
          (storage_size_bytes / system_disk_capacity_bytes) > 0.8
        for: 1h
        labels:
          severity: critical
          component: storage
          service: dorevia-vault
        annotations:
          summary: "Stockage > 80% de capacit√©"
          description: |
            {{ $value | humanizePercentage }} du disque est utilis√©.
            Nettoyer les anciens fichiers ou augmenter la capacit√©.

      # Alerte 5 : Stockage critique (>90%)
      - alert: StorageCritical
        expr: |
          (storage_size_bytes / system_disk_capacity_bytes) > 0.9
        for: 30m
        labels:
          severity: critical
          component: storage
          service: dorevia-vault
        annotations:
          summary: "Stockage critique (>90%)"
          description: |
            {{ $value | humanizePercentage }} du disque est utilis√©.
            Action imm√©diate requise.

      # Alerte 6 : M√©moire syst√®me √©lev√©e
      - alert: HighSystemMemoryUsage
        expr: |
          (system_memory_usage_bytes / system_memory_total_bytes) > 0.9
        for: 10m
        labels:
          severity: warning
          component: system
          service: dorevia-vault
        annotations:
          summary: "Utilisation m√©moire syst√®me √©lev√©e (>90%)"
          description: |
            {{ $value | humanizePercentage }} de la m√©moire est utilis√©e.
            V√©rifier les fuites m√©moire et les processus.

      # Alerte 7 : CPU syst√®me √©lev√©
      - alert: HighSystemCPUUsage
        expr: |
          system_cpu_usage_percent > 80
        for: 15m
        labels:
          severity: warning
          component: system
          service: dorevia-vault
        annotations:
          summary: "Utilisation CPU √©lev√©e (>80%)"
          description: |
            CPU √† {{ $value }}% pendant 15 minutes.
            V√©rifier la charge du syst√®me.

      # Alerte 8 : Aucun document vault√© r√©cemment (si volume attendu)
      - alert: NoRecentDocuments
        expr: |
          rate(documents_vaulted_total{status="success"}[1h]) == 0
        for: 2h
        labels:
          severity: info
          component: vault
          service: dorevia-vault
        annotations:
          summary: "Aucun document vault√© depuis 2 heures"
          description: |
            Aucun document n'a √©t√© stock√© avec succ√®s depuis 2 heures.
            V√©rifier la connectivit√© avec Odoo et les endpoints.

      # Alerte 9 : Taux de r√©conciliation √©lev√©
      - alert: HighReconciliationRate
        expr: |
          rate(reconciliation_runs_total{status="success"}[1h]) > 0.1
        for: 30m
        labels:
          severity: warning
          component: reconcile
          service: dorevia-vault
        annotations:
          summary: "R√©conciliations fr√©quentes"
          description: |
            {{ $value }} r√©conciliations/heure d√©tect√©es.
            V√©rifier l'int√©grit√© des fichiers et de la base de donn√©es.

      # Alerte 10 : Service down (via up metric)
      - alert: ServiceDown
        expr: |
          up{job="dorevia_vault"} == 0
        for: 1m
        labels:
          severity: critical
          component: service
          service: dorevia-vault
        annotations:
          summary: "Service Dorevia Vault down"
          description: |
            Le service n'est plus accessible par Prometheus.
            V√©rifier l'√©tat du service systemd.

